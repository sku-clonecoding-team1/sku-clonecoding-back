<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Seat Detail</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.1.0.js"></script> <!-- Iamport SDK -->
</head>
<body>
<h1>영화 정보</h1>
<p>좌석 ID: <span id="seatID" th:text="${seatID}"></span></p>
<p>영화 제목: <span id="movieName" th:text="${movieName}"></span></p>
<p>영화관 이름: <span id="cinemaName" th:text="${cinemaName}"></span></p>
<p>티켓 가격: <span id="ticketPrice" th:text="1"></span></p>



<!-- 내부적으로 ID 값을 저장하기 위한 hidden 필드 -->
<input type="hidden" th:value="${movieId}" id="movieId" />
<input type="hidden" th:value="${cinemaId}" id="cinemaId" />

<!-- 결제 버튼 추가 -->
<div class="ka_pay_btn">
    <button type="button" onclick="ka_request_pay()">카카오페이</button>
</div>
<div class="kg_pay_btn">
    <button type="button" onclick="kg_request_pay()">kg이니시스</button>
</div>

<script>

    function before_payment() {
        const data = {
            seatID: $('#seatID').text(),       // 텍스트 값 가져오기
            movieName: $('#movieName').text(),
            cinemaName: $('#cinemaName').text(),
            price: $('#ticketPrice').text(),   // 티켓 가격 가져오기
            movieId: $('#movieId').val(),      // 숨겨진 필드의 값
            cinemaId: $('#cinemaId').val()     // 숨겨진 필드의 값
        };

        // 결제 로그를 백엔드로 보내기
        return fetch('/paymentLogging', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(result => {
                console.log('결제 로그가 성공적으로 생성되었습니다: ', result);
                return result; // 결제 로그 ID 반환
            })
            .catch(error => {
                console.error('결제 로그 생성 중 오류 발생:', error);
                alert('결제 로그 생성 중 오류가 발생했습니다.');
            });
    }



    function loadImpCode() {
        return fetch('/api/get-imp-code')
            .then(response => response.text()) // 서버로부터 가맹점 식별코드 받기
            .then(impCode => {
                if (!impCode) {
                    throw new Error("가맹점 식별코드를 가져오지 못했습니다.");
                }
                return impCode; // 가맹점 식별코드 반환
            })
            .catch(error => {
                console.error('Error fetching impCode:', error);
                alert('가맹점 식별코드를 가져오는데 실패했습니다.');
            });
    }

    function kg_request_pay() {
        if (!window.IMP) {
            alert("결제 모듈이 로드되지 않았습니다.");
            return;
        }

        IMP = window.IMP;
        // 결제 전 로그 생성



        // 가맹점 식별코드를 로드 후 결제 처리
        loadImpCode().then(impCode => {
            IMP.init(impCode); // 가맹점 식별코드로 초기화

            IMP.request_pay({
                pg: 'html5_inicis',
                pay_method: 'card',
                merchant_uid: "order_no_0001", // 상점에서 관리하는 주문 번호를 전달
                name: '주문명:결제테스트',
                amount: 14000,
                buyer_email: 'iamport@siot.do',
                buyer_name: '구매자이름',
                buyer_tel: '010-1234-5678',
                buyer_addr: '서울특별시 강남구 삼성동',
                buyer_postcode: '123-456',
                m_redirect_url: '{모바일에서 결제 완료 후 리디렉션 될 URL}' // 예: https://www.my-service.com/payments/complete/mobile
            }, function(rsp) {
                if (rsp.success) {
                    alert('결제가 완료되었습니다.');
                    before_payment();

                    console.log(rsp);
                } else {
                    alert('결제에 실패하였습니다: ' + rsp.error_msg);
                }
            });
        }).catch(error => {
            console.error('결제 초기화 중 오류 발생:', error);
        });
    }

    function ka_request_pay() {
        if (!window.IMP) {
            alert("결제 모듈이 로드되지 않았습니다.");
            return;
        }

        IMP = window.IMP;

        // 가맹점 식별코드를 로드 후 결제 처리
        loadImpCode().then(impCode => {
            IMP.init(impCode); // 가맹점 식별코드로 초기화

            IMP.request_pay({
                pg: 'kakaopay',
                pay_method: 'card',
                merchant_uid: 'order_no_' + new Date().getTime(),
                name: '주문명:결제테스트',
                amount: 1,
                buyer_email: 'iamport@siot.do',
                buyer_name: '구매자이름',
                buyer_tel: '010-1234-5678',
                buyer_addr: '서울특별시 강남구 삼성동',
                buyer_postcode: '123-456'
            }, function(rsp) {
                if (rsp.success) {
                    alert('결제가 완료되었습니다.');
                    before_payment();

                    console.log(rsp);
                } else {
                    alert('결제에 실패하였습니다: ' + rsp.error_msg);
                }
            });
        }).catch(error => {
            console.error('결제 초기화 중 오류 발생:', error);
        });
    }
</script>

</body>
</html>
